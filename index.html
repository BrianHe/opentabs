<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <title>Opentabs</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="stylesheets/base.css">
    <link rel="stylesheet" href="stylesheets/skeleton.css">
    <link rel="stylesheet" href="stylesheets/layout.css">

    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">

    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

    <style>
        .gold { background-color: #FFFF99 }
    </style>

</head>
<body>

<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
<script>function user(data) { window.user = data; $('#welcome').val(data);  }</script>
<script src="https://data.fm/user.js"></script>

    <header>
        <a href="https://github.com/melvincarvalho/OpenTabs" rel="doap:homepage"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://d3nwyuy0nl342s.cloudfront.net/img/71eeaab9d563c2b3c590319b398dd35683265e85/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub"></a>
    </header>

    <div class="container">

        <div class="sixteen columns">
            <h1 class="remove-bottom" style="margin-top: 40px">Opentabs</h1>

            <h5 id="welcome"></h5>
            <hr />
        </div>
        <div class="one-third column">

          <ul class="tabs">
            <!-- Give href an ID value of corresponding "tabs-content" <li>'s -->
            <li><a class="active" href="#simple">My Tabs</a></li>

            <li><a href="#lightweight">Send</a></li>
            <li><a href="#mobileFriendly">Advanced</a></li>
          </ul>

          <ul class="tabs-content">     
            <li id="simple" class="active">
              <div id="opentabs">
              
              </div>
            </li>

            <li id="lightweight">
              <form>
                  <input size="20" type="text" id="payee" name="payee" value="testdummy@opentabs.net" />
                  <input type="text" size="5" id="quantity" name="amount" value="5" />
                  <input readonly="true" size="5" type="text" id="currency" name="currency" value="EUR" />
                  <input type="button" value="Send" id="save" />
              </form>
            </li>
            <li id="mobileFriendly">Advanced Settings coming soon.
              <br/>

              <form>
                <button id="clearall">Clear All IOUs</button>
              </form>
              <form action="https://data.fm/rp_auth">
                &nbsp;(WebID) <a href="https://data.fm/login?next=http://opentabs.data.fm/index.html"><img style="float: left" src="http://data.fm/common/images/loginWebID.png" /></a><br/><br/><br/>
              </form>
              <a href="https://data.fm/login?provider=Gmail&next=http://opentabs.data.fm/index.html"><img src="http://ealltd.com/images/gmail%20logo.jpg" /></a><br/><br/>
              <a href="https://data.fm/login?provider=Yahoo&next=http://opentabs.data.fm/index.html"><img src="http://www.textually.org/textually/archives/archives/images/set2/yahologo.gif" /></a>
              
              
            </li>
          </ul>

        </div>

    </div>

<script src="javascripts/tabs.js"></script>
<script src="javascripts/sha1.js"></script>
<script src="opentabs.js"></script>
<script>

(function($) {
  
  var IOU = function() { this.load() };
  IOU.prototype = {
    
    IOUs: [],
  
    load: function() {
      //this.IOUs = JSON.parse(window.localStorage.getItem('IOUs')) || [];
      this.loadRemote();
      this.render();
    },
  
    saveLocal: function() {
      if( !this.confirm() ) {
        alert('Operation Cancelled');
        return;
      }
      
      if (!this.IOUs) this.IOUs = [];
      
      this.IOUs.push(this.createIOU(window.user, this.makeURI($('#payee').val()), $('#quantity').val(), $('#currency').val()));

      window.localStorage.setItem('IOUs', JSON.stringify(this.IOUs));
      this.saveRemote();
      this.syncRemote();
      
      
      //this.load();
    },

    saveRemote: function() {
      // get user
      var user = window.user;

      // DELETE
      this.deleteFile('http://opentabs.data.fm/d/' + hex_sha1(user));      

      // PUT
      var body = '@prefix rdf: <http://www.w3.org/1999/02/22/rdf-syntax-ns#>.\n\n<> <#IOUs> "'+ escape(JSON.stringify(this.IOUs)) +'" .';
      this.putFile('http://opentabs.data.fm/d/' + hex_sha1(user), body);
      //alert('http://opentabs.data.fm/d/' + hex_sha1(user) );
      
    },

    syncRemote: function() {
      // get user
      var user = this.makeURI($('#payee').val());
      var that = this;

      try {
        $.getJSON('http://opentabs.data.fm/d/'+ hex_sha1(user) +'.json' , function(data){
          //alert(data);
          var IOUs = JSON.parse(unescape(data['http://opentabs.data.fm/d/'+hex_sha1(user)]['http://opentabs.data.fm/d/'+hex_sha1(user)+'#IOUs'][0]['value']));
          if (!IOUs) IOUs = [];        
          IOUs.push(that.createIOU($('#payee').val(), window.user, -1.0*$('#quantity').val(), $('#currency').val()));
        
          // DELETE
          that.deleteFile('http://opentabs.data.fm/d/' + hex_sha1(user));
      
          // PUT
          var body = '@prefix rdf: <http://www.w3.org/1999/02/22/rdf-syntax-ns#>.\n\n<> <#IOUs> "'+ escape(JSON.stringify(IOUs)) +'" .';
          that.putFile('http://opentabs.data.fm/d/' + hex_sha1(user), body);
        
        
          window.location.reload();
       
        }).error(function () {
          var IOUs = [];        
          IOUs.push(that.createIOU($('#payee').val(), window.user, -1.0*$('#quantity').val(), $('#currency').val()));
        
          // PUT
          var body = '@prefix rdf: <http://www.w3.org/1999/02/22/rdf-syntax-ns#>.\n\n<> <#IOUs> "'+ escape(JSON.stringify(IOUs)) +'" .';
          that.putFile('http://opentabs.data.fm/d/' + hex_sha1(user), body);
          
          window.location.reload();
          
        });
      } catch (err) {
        alert('could not sync');
      }
      

      
    },

    loadRemote: function() {
      // get user
      var user = window.user;
      that = this;

      
      $.getJSON('http://opentabs.data.fm/d/'+ hex_sha1(user) +'.json' , function(data){
        var IOUs = JSON.parse(unescape(data['http://opentabs.data.fm/d/'+hex_sha1(user)]['http://opentabs.data.fm/d/'+hex_sha1(user)+'#IOUs'][0]['value']));
        //alert(JSON.stringify(IOUs));
        that.IOUs = IOUs;
        that.render();
      });
      
      $('#welcome').html(window.user);
      
    },


    confirm: function() {
      var IOU = 'You are about to send:\n\n'+ $('#payee').val()
      IOU += '\n\nan IOU for ' + $('#quantity').val() + ' ' + $("#currency").val();
      IOU += '\n\nAre you sure?';
      return confirm(IOU);
    },

    render: function() {
      $('#opentabs').empty();
      if(!this.IOUs || !this.IOUs.length) {
        $('#opentabs').append( $('<p>').text('You don\'t currently have any open tabs.') );
        return;
      }
      
      var line = '<tr>' 
        line += '<td>IOU&nbsp;</td>';
        line += '<td class="gold">Amount&nbsp;</td>';
        line += '<td>Currency</td>';
        line += '</tr>';
      $('#opentabs').append( $('<table>').append(line) );
      
      this.IOUs.forEach(function(item) {
        if (item && item.IOU) {
          var line = '<tr>' 
          line += '<td>' + item.IOU['com:destination'] + '</td>';
          line += '<td class="gold"> ' + (-1 * item.IOU['com:amount']) + '</td>';
          line += '<td>' + item.IOU['com:currency'] + '</td>';
          line += '</tr>';
          if ( $('td:contains("'+ item.IOU['com:destination'] +'")').length > 0 ) {
            var prev = $('td:contains("'+ item.IOU['com:destination'] +'")').next().html();
            $('td:contains("'+ item.IOU['com:destination'] +'")').next().html(1.0*prev + (-1 * item.IOU['com:amount']));
          } else {
            $('#opentabs table tr:last').after(line);
Â          }
        }
      });
      
      // beautify cells
      $('td').each(function() { 
          var html = $(this).html();
          if ( html.substring(0,7) == 'mailto:' ) {
            $(this).html(html.substring(7));
          }
        } 
      );

      $('#welcome').html(window.user);
      
    },

    clear: function() {
      this.IOUs = window.localStorage.IOUs = null;
      this.saveRemote();
      this.load();
    },
    
    deleteFile: function(file) {
      var body = '';
      xhr = new XMLHttpRequest();
      xhr.open('DELETE', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(body);      
    },
    
    putFile: function(file, data) {
      xhr = new XMLHttpRequest();
      xhr.open('PUT', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(data);   
    },
    
    createIOU: function(source, destination, amount, currency) {
       
       var IOU = {
        id: '',
        IOU: {
          "a": "com:Transfer",
          "com:source": this.makeURI(source),
          "com:destination": this.makeURI(destination),
          "com:amount": amount,
          "com:currency": currency,
          "dc:created": new Date(),
          "rdfs:comment": 'a test IOU',
          "format": '0.01',
          state: 0
        }
      }    
      return IOU;
    },
    
    makeURI: function(id) {
      if ( id.substring(0,7) == 'mailto:' ) {
        return id;
      } else if ( id.indexOf(':') != -1 ) {
        return id;
      } else {
        return 'mailto:' + id;
      }
    }
    
  };
  
  $(document).ready(function() {
    document.IOU = new IOU;
    $('#clearall').click(function() { document.IOU.clear() });
    $('#save').click(function() { document.IOU.saveLocal() });
  });
  
})(jQuery);



</script>

</body>
</html>
